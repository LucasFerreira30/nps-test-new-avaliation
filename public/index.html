<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AvaliaÃ§Ã£o de Atendimento</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="cpf-overlay" id="cpf-overlay">
        <div class="cpf-container">
            <h2>Por favor, insira seu CPF para iniciar a avaliaÃ§Ã£o</h2>
            <input type="text" id="cpf-input" class="cpf-input" maxlength="11" placeholder="Digite seu CPF" />
            <button class="cpf-button" id="cpf-button">Confirmar</button>
        </div>
    </div>

    <div class="container">
        <div class="left">
            <h1>Avalie</h1>
            <p>De 0 a 10, quanto vocÃª recomendaria a Drogarias Pacheco para um amigo ou um parente?</p>
            <div class="emoji" id="emoji">ğŸ˜</div>
            <div class="rating-buttons" id="rating-buttons">
                <!-- BotÃµes de 0 a 10 -->
            </div>
        </div>
        <div class="right">
            <p>Deixe sua opiniÃ£o, pule clicando no X para nÃ£o responder uma questÃ£o.</p>
            <ul class="feedback-list">
                <li>
                    Atendimento </br>
                    <button class="feedback-button" data-feedback="atendimento" data-value="positivo">ğŸ‘</button>
                    <button class="feedback-button" data-feedback="atendimento" data-value="negativo">ğŸ‘</button>
                    <button class="feedback-button" data-feedback="atendimento" data-value="ignore">X</button>
                </li>
                <!-- Outros campos de feedback -->
            </ul>
            <textarea class="comment-box" maxlength="600" placeholder="Como podemos melhorar?"></textarea>
            <button class="submit-button" id="submit-button">Enviar AvaliaÃ§Ã£o</button>
        </div>
    </div>

    <script>
        let rating = null;
        let feedback = {
            atendimento: null,
            comentario: ""
        };

        // Preencher os botÃµes de avaliaÃ§Ã£o de 0 a 10
        const ratingButtonsDiv = document.getElementById('rating-buttons');
        const emojiDiv = document.getElementById('emoji');
        const emojis = ['ğŸ˜¡', 'ğŸ˜ ', 'ğŸ˜', 'ğŸ˜•', 'ğŸ˜', 'ğŸ™‚', 'ğŸ˜Š', 'ğŸ˜€', 'ğŸ˜ƒ', 'ğŸ˜„', 'ğŸ˜'];

        for (let i = 0; i <= 10; i++) {
            const button = document.createElement('button');
            button.innerText = i;
            button.style.backgroundColor = `rgb(${255 - i * 25}, ${i * 25}, 0)`;
            button.onclick = () => {
                rating = i;
                emojiDiv.innerText = emojis[i];
            };
            ratingButtonsDiv.appendChild(button);
        }

        // Coleta de feedback
        document.querySelectorAll('.feedback-button').forEach(button => {
            button.onclick = function() {
                const feedbackType = this.dataset.feedback;
                const value = this.dataset.value;
                if (value === 'ignore') {
                    feedback[feedbackType] = null;
                } else {
                    feedback[feedbackType] = value;
                }
                this.style.backgroundColor = '#4CAF50';
            };
        });

        const commentBox = document.querySelector('.comment-box');
        commentBox.oninput = function() {
            feedback.comentario = this.value;
        };

        const cpfOverlay = document.getElementById('cpf-overlay');
        const cpfInput = document.getElementById('cpf-input');
        const cpfButton = document.getElementById('cpf-button');

        cpfButton.onclick = function() {
            const cpf = cpfInput.value;
            if (cpf.length === 11 && !isNaN(cpf)) {
                cpfOverlay.style.display = 'none';
            } else {
                alert('CPF invÃ¡lido. Por favor, insira um CPF vÃ¡lido com 11 dÃ­gitos.');
            }
        };

        const submitButton = document.getElementById('submit-button');

        // Coleta do IP
        fetch('https://api.ipify.org?format=json')
            .then(response => response.json())
            .then(data => {
                const ip = data.ip;

                submitButton.onclick = function() {
                    if (rating === null || Object.values(feedback).some(value => value === null)) {
                        alert('Por favor, preencha todos os campos obrigatÃ³rios antes de enviar.');
                        return;
                    }

                    fetch('https://novo-nps-survey-solucx-ayzhpaluo.vercel.app/api/avaliacao', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            cpf: cpfInput.value,
                            rating: rating,
                            feedback: feedback,
                            ip: ip // Enviando o IP
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            window.location.href = "https://www.drogariaspacheco.com.br";
                        } else {
                            alert('Erro ao enviar a avaliaÃ§Ã£o. Tente novamente.');
                        }
                    });
                };
            });
    </script>

    <div class="footer-content">
        <p class="text-muted">
            Caso tenha dÃºvidas ou solicitaÃ§Ãµes, <a href="https://www.drogariaspacheco.com.br/ajuda" target="_blank">clique aqui e fale conosco</a>
        </p>
        <p>Desenvolvido por T.I Express Survey Solutions for Drugstores and Pharmacy</p>
    </div>
</body>
</html>
